<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{csrfToken}}">
    <title>{{product.name}} - SecureShop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    {{> header}}

    <!-- Toast notifications -->
    <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 11">
        <div id="cart-toast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Product added to cart!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Error Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="errorToastMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                {{#if product.image_url}}
                <img src="{{product.image_url}}" class="img-fluid rounded" alt="{{product.name}}">
                {{else}}
                <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height: 400px;">
                    <span class="text-muted">No Image Available</span>
                </div>
                {{/if}}
            </div>
            <div class="col-md-6">
                <h1>{{product.name}}</h1>
                <p class="lead">{{product.description}}</p>
                <h3 class="text-success">${{product.price}}</h3>
                <p><strong>Category:</strong> {{product.category}}</p>
                <p><strong>Stock:</strong> {{product.stock_quantity}} available</p>

                {{#if user}}
                <div class="mt-4">
                    <div class="input-group mb-3" style="max-width: 200px;">
                        <span class="input-group-text">Quantity</span>
                        <input type="number" class="form-control" id="quantity" value="1" min="1" max="{{product.stock_quantity}}">
                    </div>
                    <button class="btn btn-success btn-lg add-to-cart" data-product-id="{{product.id}}">Add to Cart</button>
                </div>
                {{else}}
                <div class="mt-4">
                    <p class="text-muted">Please <a href="/auth/login">login</a> to add items to your cart.</p>
                </div>
                {{/if}}

                {{#if (eq user.role "admin")}}
                <div class="mt-3">
                    <a href="/products/admin/{{product.id}}/edit" class="btn btn-warning">Edit Product</a>
                    <form action="/products/admin/{{product.id}}/delete" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this product?')">
                        <button type="submit" class="btn btn-danger">Delete Product</button>
                    </form>
                </div>
                {{/if}}
            </div>
        </div>
    </div>

    {{> footer}}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const getCsrfToken = () => document.querySelector('meta[name="csrf-token"]')?.content || '';

        // Add to cart functionality
        document.querySelector('.add-to-cart')?.addEventListener('click', async () => {
            const quantity = document.getElementById('quantity').value;
            const productId = '{{product.id}}';
            try {
                const response = await fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'csrf-token': getCsrfToken()
                    },
                    credentials: 'include',
                    body: JSON.stringify({ product_id: parseInt(productId), quantity: parseInt(quantity) })
                });
                const data = await response.json();
                if (response.ok) {
                    const toast = new bootstrap.Toast(document.getElementById('cart-toast'));
                    toast.show();
                    updateCartCount(data.itemCount);
                    location.reload()
                } else {
                    showErrorToast(data.message || 'Error adding to cart');
                }
            } catch (error) {
                showErrorToast('Error adding to cart');
            }
        });

        function updateCartCount(count) {
            const cartCount = document.getElementById('cart-count');
            if (cartCount) {
                cartCount.textContent = count;
            }
        }

        function showErrorToast(message) {
            const errorToastMessage = document.getElementById('errorToastMessage');
            errorToastMessage.textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('errorToast'));
            toast.show();
        }
    </script>
</body>
</html>
